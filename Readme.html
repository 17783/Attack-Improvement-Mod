<h1>BATTLETECH Attack Improvement Mod</h1>

<p>
   This mod fixes a few serious hit bugs in the BATTLETECH game, especially head shot chances and lack of vehicle called shot, so that they work <i>as intended</i>.
   If you think you get too much headshots and you called shots miss too much, this is your mod.
</p>
<p>
   By editing this mod's "mod.json" as a text file, you can also adjust strength of roll correction, see real and detailed hit chances, and/or log hit rolls and location rolls.
</p>

<details>
   <summary><h2>Install Instructions</h2></summary>
   <p>
      Most BATTLETECH mods requires BTML and ModTek. This mod is no exception.
      The <a href="https://github.com/Mpstark/ModTek/wiki">ModTek wiki</a> may have more up-to-date <a href="https://github.com/Mpstark/ModTek/wiki/The-Drop-Dead-Simple-Guide-to-Installing-BTML-&-ModTek-&-ModTek-mods">install instructions</a>.
   </p>
   <details>
      <summary><h3>Step 1: Find Game Folder </h3></summary>
      <ol>
         <li> Open File Explorer. Click "This PC" on the left. In the top right corner it should says "Search This PC".
         <li> Click on it and type "BATTLETECH", without the quote. Your PC may take a while to do the search.
         <li> If you get one result, that is the game folder.
         <li> If you get multiple results, right click each one and "Open in new window". This will keep the search result untouched.
         <li> The one that has a "BattleTech_Data" folder is your game folder. You should also see the BattleTech icon and BattleTechLauncher icon.
      </ol>
   </details>
   <details>
      <summary><h3>Step 2: Install BTML</h3></summary>
      <ol>
         <li> Download and Extract <a href="https://github.com/Mpstark/BattleTechModLoader/releases
         ">BTML</a>. You should see three files - two dll and one exe.
         <li> Find the BATTLETECH\BattleTech_Data\Managed folder (where BATTLETECH is your game folder.)</li>
         <li> The correct folder should have lots of file. One of them should be "Assembly-CSharp.dll". If you don't see this file you're in the wrong folder.
         <li> Copy all three files to it. Then run "BattleTechModLoaderInjector". Say yes if it ask whether to overwrite.
         <li> It should says "Injection complete!" or "Assembly-CSharp.dll already injected".
         <li> The Injector need to be run every time the game is updated.
      </ol>
   </details>
   <details>
      <summary><h3>Step 3: Install ModTek</h3></summary>
      <ol>
         <li> Download <a href="https://github.com/Mpstark/ModTek/releases">ModTek.dll</a>
         <li> Create a "Mods" folder in the game folder (Right click in the folder, New > Folder) and put the dll in it
         <li> Launch the Game. At the bottom of main menu there is a version string. Part of it should be "W/ MODTEK".
      </ol>
   </details>
   <details open>
      <summary><h3>Step 4: Install this mod</h3></summary>
      <ol>
         <li> Download and extact this mod to the Mods folder of the game.
         <li> i.e. BATTLETECH\Mods\AttackImprovementMod\ should contains "mod.json", "AttackImprovementMod.dll", and other files and folders
         <li> Exit and Re-launch the game and the mod should be loaded.  If it doesn't, BTModLoader.log will log why.
         <li> This mod also keeps its own log of what it can or cannot try to modify in the log folder.
      </ol>
   </details>
</details>

<details open>
   <summary><h2>Features</h2></summary>
   <p>
      The mod has many features, which can individually be enabled, disabled, or sometimes adjusted.
   </p>
   <p>
      The mod is developed and tested on BATTLETECH v1.1 (Beta).
      Some features may not work or may work incorrectly in other game versions.
   </p>
   <ul>
      <li>
<!--


      /* Called shot have absolutely no effect on vehicles, probaly because there isn't enough time to implement it.
       * In the code, Mech Locations and Vehicle Locations are two separate enum, meaning there are two set of states and methods to handle hit location .
       * And vechicle's called shot method state/chain is only partially complete.  You can't reach the terminal station if any part of the rail is broken.
       *
       * Note that Vehicle called shot has no clustering; the default vehicle clustering is a real mess, and there are too few locations to cluster.
       *
       * This mod can re-enable called shot on vehicles. HBS do you need a proven remote freelancer? */
      public bool FixVehicleCalledShot = true;

      /* The game's hit distribution is verified (on ver 1.0.4) to be very imprecise because of improper float to int conversion.
       * For example it would rounded all head shot% to a bigger chances, causing almost double non-called headshot then intended.
       *
       * This mod can replace the "static HitLocation.GetHitLocation" with an improved version that has 1000x better precision, without using slow floats.
       * Enabling this fix would lower global headshot chances, but called shots chances can be fixed by enabling FixHeadCalledShot. */
      public bool FixHitDistribution = true;

      /* Enable clustering effect for called shots against mechs.
       * e.g. Called shot to the head would cause more shots to hit the torsos than normal.
       * This is the default behaviour of BATTLETECH v1.0, but later removed in v1.1.
       * (Vehicle does not use clustering at all; too few locations.)
       * 
       * Note that unlike real clustering, head chance will be amplified when and only when it is called shot target.
       * Fixing this for BATTLETECH v1.0 is one of the three original aims of the mod.
       * 
       * Set to 1.0 would see the called shot location enjoying full multiplers from both called shot and clustering,
       * result in very high hit chance, and by default tuned down by MechCalledShotMultiplier. */
      public bool CalledShotUseClustering = true;

      /* Called shot against mechs may be amplified by clustering rule which make them much more powerful than the game seem to believe.
       * This can cause head hit chance is up to 40% when head multiplier is fixed, when clustering is enabled e.g. game ver 1.0.
       *
       * This setting let you tune called shot's weight multipliers.  Default is 0.33 to counter the effect of CalledShotClusterStrength.
       * Set to 1.0 would disable adjustment, while 0.0 will leave only clustering effect (if any). */
      public float MechCalledShotMultiplier = 0.33f;

      /* Called shot didn't work on vehicles without modding.
       * Once that is fixed, unmodified called shot is pretty powerful on vechicles.
       * This setting tries to fix that. Default 0.75 to tune down the strength of vehicle called shot. */
      public float VehicleCalledShotMultiplier = 0.75f;

      /* Override called shot percentage display of mech locations to show true shot distribution.
       * Work with any combination of fixes; disable all.of them to get the true % of the base game.
       *
       * It is possible that the game will update called shot algorithm and cause this override to become inaccurate,
       * then you may disable this override until the mod updates. */
      public bool ShowRealMechCalledShotChance = true;

      /* Override called shot percentage display of vehicle locations to show true shot distribution.
       * When the mod was authored, vehicles do not respect called shot. This override reflects the bug.
       *
       * It is possible that the game will update called shot algorithm and cause this override to become inaccurate,
       * then you may disable this override until the mod updates. */
      public bool ShowRealVehicleCalledShotChance = true;

      /* If called shot percentage display is overridden, location hit chance can be displayed to one decimal point. */
      public bool ShowDecimalCalledChance = false;

      /* BattleTech is known to adjust Hit Rolls, so that 75% hit is actually 84% and 25% is actuall 16%.
       * This roll "correction" can be disabled.
       *
       * 0.0 disables roll correction. 1.0 means use original correction, 2.0 means double strength, etc.
       * Default is 0.5 which lowers correction strength to half. */
      public float RollCorrectionStrength = 0.5f;

      /* Show the real (corrected) hit chances in weapon panel, instead of original chances. */
      public bool ShowRealWeaponHitChance = false;

      /* Override weapon hit chance display to one decimal point.
       * Can be enabled independently from RollCorrectionStrength and ShowRealWeaponHitChance,
       * for example if some other mods do their own display correction and you want to see the decimals. */
      public bool ShowDecimalHitChance = false;

      /* Enable this to log hit roll, hit correction, location roll, location weight and other info to "BATTLETECH\Mods\FixHitLocation\log_roll.txt" in tab separated value (tsv).
       * Weight of front armours and rear armours are combined to keep the log simple.
       *
       * Expect high disk activity when enabled. Can log even when all other fixes are disabled.  Default disabled. */
      public bool LogHitRolls = false;
      
-->
   </ul>
</details>


<details>
   <summary><h2>Moding this mod</h2></summary>
   <p>
      The source code of this mod is open and free. <br>
      You can take it and modify it, provided that you include <i>your</i> code when you distribute your work, and don't claim my work as yours.
      License: AGPL v3 - local / <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">online</a>.
   </p>
   <p>
      If you know programming, you can follow these steps to see game code and where to learn how BATTLETECH mod works:
   </p>
   <ol>
      <li> Install <a href="https://www.visualstudio.com/downloads/
      ">Visual Studio</a>, or VS. This mod is developed with VS 2017 Community Edition. You'll need the ".NET desktop development" workload.
      <li> Down and Run <a href="https://github.com/0xd4d/dnSpy/releases">DnSpy</a>
      <li> Download DnSpy's Unity x64 debugging zip, extract the 5.6.5 mono.dll, and replace the game's one.
      <li> Create an Environment Variable "DNSPY_UNITY_DBG" with the value "--debugger-agent=transport=dt_socket,server=y,address=127.0.0.1:55555,defer=y" (both without the quotes). This will instruct the modified game to connect to DnSpy.
      <li> Run the game. If you want you can <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview">check that</a> its port 55555 is opened.
      <li> Launch the modified BATTLETECH game.
      <li> In DnSpy, click the Start button on toolbar, or the "Start Debugging" menu item. This will popup a dialogue. Select "Unity (Connect)" and leave other settings at default.
      <li> DnSpy should now be connected to the game and the stats says "Running...".
      <li> Go to Debug > Windows > Modules, double click "Assembly-CSharp.dll".  This will load the assembly.  It contains most BATTLETECH code.
      <li> You may now search and browse the assembly!  For example in the search tab you can type "GetCorrectedRoll" to find the method. Clicking on it will show you the roll correction code.
      <li> Right click on method name (or any identifier) and click "Analyze".  It'll help you find where and how the method is called, or its override hierarchy.
      <li> Left click the assembly, then File > Export to Project. This will decompile all code which you can browse with other editor or IDE. <li>
      <li> Head to the <a href="https://github.com/Mpstark/ModTek/wiki">ModTek wiki</a> to learn how to make a mod.  For a code mode like this one, you need <a href="https://github.com/Mpstark/ModTek/wiki/The-mod.json-Format">"mod.json"</a> and <a href="https://github.com/Mpstark/ModTek/wiki/Writing-ModTek-DLL-mods">dll</a>.
      <li> You may notice that this patch manually calls Harmony to patch things, instead of using Annotation. This gives me much better control such as sharing of patch methods. You may read <a href="https://github.com/pardeike/Harmony/wiki">Harmony wiki</a> to learn how it works.
   </ol>
</details>


<style>
   p, li { font-size: 120%; }
   h1, h2, h3 { display: inline-block; }
</style>